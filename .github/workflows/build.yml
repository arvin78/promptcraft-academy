name: Build APK (arm64-v8a)

on:
  workflow_dispatch:
  push:
    paths:
      - "*.zip"
      - ".github/workflows/build.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Find newest ZIP in repo root
        id: zip
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          files=( *.zip )
          if [ ${#files[@]} -eq 0 ]; then
            echo "❌ No .zip found in repo root." >&2
            exit 1
          fi

          best_line=$(for f in "${files[@]}"; do
            ts=$(git log -1 --format=%ct -- "$f" 2>/dev/null || echo 0)
            echo "$ts $f"
          done | sort -nr | head -n 1)

          best=$(echo "$best_line" | awk '{ $1=""; sub(/^ /,""); print }')
          echo "✅ Using ZIP: $best"
          echo "zip=$best" >> "$GITHUB_OUTPUT"

      - name: Extract ZIP
        shell: bash
        run: |
          set -euo pipefail
          rm -rf app project
          mkdir -p app

          unzip -q "${{ steps.zip.outputs.zip }}" -d app

          # حالت 1: پروژه مستقیم داخل app/ است
          if [ -f "app/pubspec.yaml" ]; then
            mv app project
          else
            # حالت 2: پروژه داخل یک پوشه‌ی داخلی است
            proj=$(find app -maxdepth 2 -name pubspec.yaml -print -quit | xargs -r dirname)
            if [ -z "${proj:-}" ]; then
              echo "❌ pubspec.yaml not found after unzip." >&2
              find app -maxdepth 3 -type f | head -n 200
              exit 1
            fi
            mv "$proj" project
          fi

          echo "Project folder:"
          ls -al project | head -n 50

      - name: Ensure Android folder exists
        working-directory: project
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d "android" ]; then
            flutter create . --platforms=android
          fi

      - name: Pub get
        working-directory: project
        run: flutter pub get

      - name: Build arm64-v8a release APK (split per ABI)
        working-directory: project
        run: flutter build apk --release --split-per-abi

      - name: Upload artifact (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: app-arm64-v8a-release
          path: project/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk 
