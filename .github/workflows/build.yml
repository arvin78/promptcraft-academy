name: Build Android APK (Lessons Fix + arm64-v8a)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build.yml"
      - "**/*.zip"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.3"
          channel: stable
          cache: true

      - name: Select ZIP (must contain pubspec.yaml)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import glob, zipfile, os, sys

          zips = [p for p in glob.glob("**/*.zip", recursive=True) if "/.git/" not in p and not p.startswith(".git/")]
          if not zips:
              print("❌ No .zip found in repo")
              sys.exit(1)

          chosen = None
          for p in zips:
              try:
                  with zipfile.ZipFile(p) as z:
                      if any(n.endswith("pubspec.yaml") for n in z.namelist()):
                          chosen = p
                          break
              except Exception:
                  pass

          if not chosen:
              chosen = zips[0]

          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as f:
              f.write(f"ZIP_PATH={chosen}\n")

          print("✅ Using ZIP:", chosen)
          PY

      - name: Extract ZIP
        shell: bash
        run: |
          set -euo pipefail
          rm -rf extracted
          mkdir -p extracted
          unzip -q "$ZIP_PATH" -d extracted

      - name: Find Flutter ROOT (pubspec.yaml)
        shell: bash
        run: |
          set -euo pipefail
          ROOT="$(python3 - <<'PY'
          from pathlib import Path
          pubs = list(Path("extracted").rglob("pubspec.yaml"))
          if not pubs:
              raise SystemExit("❌ pubspec.yaml not found after extraction")
          pubs.sort(key=lambda p: len(str(p)))
          print(str(pubs[0].parent))
          PY
          )"
          echo "ROOT=$ROOT" >> "$GITHUB_ENV"
          echo "✅ ROOT=$ROOT"

      - name: Fix missing lessons (create assets/lessons/*.md + patch pubspec assets)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, re
          from pathlib import Path

          root = Path(os.environ["ROOT"])
          assets_dir = root / "assets" / "lessons"
          assets_dir.mkdir(parents=True, exist_ok=True)

          # Find lesson IDs like m01_l01, m01_l107, ...
          pat = re.compile(r"m\d{1,2}_l\d{1,3}", re.IGNORECASE)
          ids = set()

          for f in root.rglob("*"):
            if not f.is_file():
              continue
            if f.suffix.lower() not in (".dart", ".json", ".md", ".txt", ".yaml", ".yml"):
              continue
            try:
              txt = f.read_text(encoding="utf-8", errors="ignore")
            except Exception:
              continue
            for m in pat.finditer(txt):
              ids.add(m.group(0).lower())

          ids = sorted(ids)
          created = 0
          for lid in ids:
            p = assets_dir / f"{lid}.md"
            if not p.exists() or p.stat().st_size < 40:
              p.write_text(
                f"# {lid}\n\n"
                "این درس هنوز کامل نشده، اما این فایل اضافه شد تا پیام «محتوا پیدا نشد» نمایش داده نشود.\n\n"
                "## خلاصه سریع\n"
                "- هدف\n- نکات کلیدی\n- مثال\n- تمرین\n",
                encoding="utf-8"
              )
              created += 1

          # Patch pubspec.yaml safely (without duplicating flutter/assets)
          pubspec = root / "pubspec.yaml"
          txt = pubspec.read_text(encoding="utf-8", errors="ignore").splitlines(True)

          def find_line(rx):
            for i, line in enumerate(txt):
              if re.match(rx, line):
                return i
            return -1

          flutter_i = find_line(r"^\s*flutter:\s*$")
          if flutter_i == -1:
            txt.append("\nflutter:\n")
            txt.append("  assets:\n")
            txt.append("    - assets/lessons/\n")
          else:
            # look for assets: under flutter:
            assets_i = -1
            for i in range(flutter_i + 1, len(txt)):
              # stop if next top-level key starts
              if re.match(r"^[A-Za-z_].*:\s*$", txt[i]) and not txt[i].startswith(" "):
                break
              if re.match(r"^\s{2}assets:\s*$", txt[i]):
                assets_i = i
                break

            if assets_i == -1:
              # insert assets section right after flutter:
              insert_at = flutter_i + 1
              txt.insert(insert_at, "  assets:\n")
              txt.insert(insert_at + 1, "    - assets/lessons/\n")
            else:
              # check if already listed
              already = any("assets/lessons/" in line for line in txt[assets_i:assets_i+200])
              if not already:
                txt.insert(assets_i + 1, "    - assets/lessons/\n")

          pubspec.write_text("".join(txt), encoding="utf-8")

          report = root / "PATCH_REPORT.txt"
          report.write_text(
            f"lesson_ids_found={len(ids)}\n"
            f"md_created_or_updated={created}\n"
            f"assets_path=assets/lessons/\n",
            encoding="utf-8"
          )
          print(report.read_text(encoding="utf-8"))
          PY

      - name: Flutter pub get
        shell: bash
        run: |
          set -euo pipefail
          cd "$ROOT"
          flutter pub get

      - name: Build APKs (split per ABI incl. arm64-v8a)
        shell: bash
        run: |
          set -euo pipefail
          cd "$ROOT"
          flutter build apk --debug --split-per-abi

      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          cp -v "$ROOT"/build/app/outputs/flutter-apk/*.apk out/ || true
          cp -v "$ROOT"/PATCH_REPORT.txt out/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: out
