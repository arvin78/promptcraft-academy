name: Build Android (APK) from ZIP

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.zip"
      - ".github/workflows/**"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install unzip + python
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip python3

      - name: Pick ZIP (any name)
        id: pick
        shell: bash
        run: |
          set -e
          ZIP="$(find . -maxdepth 3 -type f -iname '*.zip' | head -n 1)"
          if [ -z "$ZIP" ]; then
            echo "ERROR: No .zip found."
            exit 1
          fi
          echo "Chosen ZIP: $ZIP"
          echo "zip=$ZIP" >> $GITHUB_OUTPUT

      - name: Extract ZIP
        shell: bash
        run: |
          rm -rf extracted
          mkdir -p extracted
          unzip -q "${{ steps.pick.outputs.zip }}" -d extracted
          ls -la extracted

      - name: Find Flutter root (pubspec.yaml)
        id: root
        shell: bash
        run: |
          set -e
          if [ -f "extracted/pubspec.yaml" ]; then
            ROOT="extracted"
          else
            PUBSPEC="$(find extracted -maxdepth 6 -name pubspec.yaml -print -quit)"
            if [ -z "$PUBSPEC" ]; then
              echo "ERROR: pubspec.yaml not found."
              exit 1
            fi
            ROOT="$(dirname "$PUBSPEC")"
          fi
          echo "root=$ROOT" >> $GITHUB_OUTPUT
          echo "Using ROOT=$ROOT"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # ---------------- HOTFIXES (NO ZIP REUPLOAD) ----------------
      - name: Hotfix - patch Dart compile errors
        shell: bash
        working-directory: ${{ steps.root.outputs.root }}
        run: |
          set -e
          python3 - <<'PY'
          import pathlib

          def patch_file(path, repls):
            p = pathlib.Path(path)
            if not p.exists():
              print("Skip (missing):", path)
              return
            txt = p.read_text(encoding="utf-8", errors="replace")
            original = txt
            for a,b in repls:
              txt = txt.replace(a,b)
            if txt != original:
              p.write_text(txt, encoding="utf-8")
              print("Patched:", path)
            else:
              print("No change:", path)

          # 1) Fix broken quotes in error_lab_engine.dart
          patch_file("lib/src/services/error_lab_engine.dart", [
            ("'این خطا معمولاً از کوتیشن‌های شکسته یا متن چندخطی داخل '...'.',",
             "\"این خطا معمولاً از کوتیشن‌های شکسته یا متن چندخطی داخل '...'.\","),
            ("'در Dart برای متن چندخطی از \"\"\" استفاده کن، نه '...'.',",
             "\"در Dart برای متن چندخطی از \\\"\\\"\\\" استفاده کن، نه '...'.\","),
          ])

          # 2) Fix context name collision in prompt_builder_page.dart
          p = pathlib.Path("lib/src/features/tools/prompt_builder_page.dart")
          if p.exists():
            txt = p.read_text(encoding="utf-8", errors="replace")
            txt = txt.replace("final context = TextEditingController", "final userContext = TextEditingController")
            txt = txt.replace("${context.text}", "${userContext.text}")
            txt = txt.replace("context.dispose()", "userContext.dispose()")
            txt = txt.replace("Widget build(BuildContext context)", "Widget build(BuildContext ctx)")
            txt = txt.replace("ScaffoldMessenger.of(context)", "ScaffoldMessenger.of(ctx)")
            txt = txt.replace("_field('کانتکست', context", "_field('کانتکست', userContext")
            p.write_text(txt, encoding="utf-8")
            print("Patched:", p)

          # 3) Fix num->double in dashboard_page.dart
          patch_file("lib/src/features/dashboard/dashboard_page.dart", [
            ("final pct = totalLessons == 0 ? 0 : (completedCount / totalLessons);",
             "final pct = totalLessons == 0 ? 0.0 : (completedCount / totalLessons);"),
          ])
          PY
      # ------------------------------------------------------------

      - name: Ensure Android folder exists
        working-directory: ${{ steps.root.outputs.root }}
        run: |
          if [ ! -d "android" ]; then
            flutter create --platforms android .
          fi

      - name: Pub get
        working-directory: ${{ steps.root.outputs.root }}
        run: flutter pub get

      - name: Analyze (non-fatal)
        working-directory: ${{ steps.root.outputs.root }}
        run: flutter analyze --no-fatal-infos --no-fatal-warnings || true

      - name: Build APK (debug)
        working-directory: ${{ steps.root.outputs.root }}
        shell: bash
        run: |
          set -o pipefail
          flutter build apk --debug 2>&1 | tee flutter_build.log

      - name: Collect artifacts (APK + log)
        if: always()
        shell: bash
        run: |
          mkdir -p artifacts
          ROOT="${{ steps.root.outputs.root }}"
          find "$ROOT/build" -type f -name "*.apk" -print -exec cp {} artifacts/ \; || true
          [ -f "$ROOT/flutter_build.log" ] && cp "$ROOT/flutter_build.log" artifacts/ || true
          ls -la artifacts || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: artifacts/* 
