name: Build Android (APK) from ZIP

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.38.5"
          cache: true

      - name: Unzip source ZIP (pick largest)
        shell: bash
        run: |
          set -euo pipefail
          ZIP="$(ls -S *.zip | head -n 1)"
          echo "Using ZIP: $ZIP"
          rm -rf extracted
          mkdir -p extracted
          unzip -q "$ZIP" -d extracted

      - name: Locate Flutter project root (pubspec.yaml)
        id: root
        shell: bash
        run: |
          set -euo pipefail
          ROOT="$(dirname "$(find extracted -name pubspec.yaml -print -quit)")"
          if [ -z "$ROOT" ]; then
            echo "pubspec.yaml not found inside ZIP" >&2
            exit 1
          fi
          echo "root=$ROOT" >> "$GITHUB_OUTPUT"
          echo "ROOT=$ROOT" >> "$GITHUB_ENV"
          echo "Found ROOT=$ROOT"

      - name: Auto-fix pubspec.yaml (safe)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import re, pathlib, os
          p = pathlib.Path(os.environ["ROOT"]) / "pubspec.yaml"
          if not p.exists():
              print("pubspec.yaml not found, skipping")
              raise SystemExit(0)

          txt = p.read_text(encoding="utf-8", errors="replace")
          orig = txt

          # normalize fancy quotes that break YAML sometimes
          txt = txt.replace("“", '"').replace("”", '"').replace("’", "'")

          # very conservative fix: if "sdk: flutter" appears directly under dependencies: without "flutter:" key
          lines = txt.splitlines()
          out = []
          i = 0
          while i < len(lines):
              line = lines[i]
              if re.match(r'^\s*sdk\s*:\s*flutter\s*$', line):
                  j = len(out) - 1
                  while j >= 0 and out[j].strip() == "":
                      j -= 1
                  if j >= 0 and re.match(r'^\s*dependencies\s*:\s*$', out[j]):
                      indent = len(line) - len(line.lstrip(" "))
                      base = " " * indent
                      out.append(base + "flutter:")
                      out.append(base + "  sdk: flutter")
                      i += 1
                      continue
              out.append(line)
              i += 1

          new_txt = "\n".join(out) + ("\n" if orig.endswith("\n") else "")
          if new_txt != orig:
              p.write_text(new_txt, encoding="utf-8")
              print("pubspec.yaml patched")
          else:
              print("pubspec.yaml ok")
          PY

      - name: Patch ProgressStore (NO replaceFirst bug)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, pathlib, textwrap, re
          root = pathlib.Path(os.environ["ROOT"])
          targets = list(root.rglob("progress_store.dart"))
          if not targets:
              print("progress_store.dart not found; skipping")
              raise SystemExit(0)

          new_store = textwrap.dedent(r'''
          // AUTO-GENERATED by GitHub Actions to ensure the sample app compiles.
          // If you later implement a real persistence layer, replace this file.

          import 'dart:convert';
          import 'package:flutter/foundation.dart';

          class ProgressStore extends ChangeNotifier {
            /// Lesson completion flags by lessonId
            final Map<String, bool> completedLessons = <String, bool>{};

            /// Quiz best scores by quizId
            final Map<String, int> quizScores = <String, int>{};

            /// Spaced-repetition raw state (opaque to UI)
            final Map<String, dynamic> _srsRaw = <String, dynamic>{};

            // ---- Lessons ----
            bool isLessonCompleted(String lessonId) => completedLessons[lessonId] == true;

            Future<void> setLessonCompleted(String lessonId, bool done) async {
              completedLessons[lessonId] = done;
              notifyListeners();
            }

            // ---- Quizzes ----
            int getQuizScore(String quizId) => quizScores[quizId] ?? 0;

            Future<void> setQuizScore(String quizId, int score) async {
              quizScores[quizId] = score;
              notifyListeners();
            }

            // ---- Compatibility methods ----
            Future<void> resetAll() async {
              completedLessons.clear();
              quizScores.clear();
              _srsRaw.clear();
              notifyListeners();
            }

            // Backwards compatibility aliases
            bool isCompleted(String lessonId) => isLessonCompleted(lessonId);
            Future<void> markCompleted(String lessonId) => setLessonCompleted(lessonId, true);
            Future<void> unmarkCompleted(String lessonId) => setLessonCompleted(lessonId, false);

            // ---- Persistence (in-memory only for now) ----
            String exportJson() {
              final data = <String, dynamic>{
                'completedLessons': completedLessons,
                'quizScores': quizScores,
                'srs': _srsRaw,
              };
              return jsonEncode(data);
            }

            Future<void> importJson(String json) async {
              try {
                final data = jsonDecode(json) as Map<String, dynamic>;
                completedLessons
                  ..clear()
                  ..addAll((data['completedLessons'] as Map?)?.map((k, v) => MapEntry('$k', v == true)) ?? {});
                quizScores
                  ..clear()
                  ..addAll((data['quizScores'] as Map?)?.map((k, v) => MapEntry('$k', (v is num) ? v.toInt() : 0)) ?? {});
                _srsRaw
                  ..clear()
                  ..addAll((data['srs'] as Map?) ?? {});
                notifyListeners();
              } catch (_) {
                // ignore bad imports
              }
            }
          }
          ''').lstrip("\n")

          for p in targets:
              txt = p.read_text(encoding="utf-8", errors="replace")
              if "AUTO-GENERATED by GitHub Actions" in txt:
                  print("ProgressStore already patched:", p)
                  continue
              if re.search(r'\bFuture<\s*void\s*>\s*resetAll\s*\(', txt) and "exportJson" in txt:
                  print("ProgressStore already has compatibility methods:", p)
                  continue
              p.write_text(new_store, encoding="utf-8")
              print("ProgressStore overwritten:", p)
          PY

      - name: Flutter pub get
        working-directory: ${{ steps.root.outputs.root }}
        run: flutter pub get

      - name: Build APKs (debug + split per ABI) + save log
        id: build
        working-directory: ${{ steps.root.outputs.root }}
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          flutter --version
          flutter clean

          set +e
          flutter build apk --debug --split-per-abi -v 2>&1 | tee "$GITHUB_WORKSPACE/flutter_build.log"
          exitcode=${PIPESTATUS[0]}
          echo "exitcode=$exitcode" >> "$GITHUB_OUTPUT"
          set -e

          OUTDIR="$GITHUB_WORKSPACE/build_out"
          rm -rf "$OUTDIR"
          mkdir -p "$OUTDIR"
          cp -v build/app/outputs/flutter-apk/*.apk "$OUTDIR/" 2>/dev/null || true
          ls -lah "$OUTDIR" || true

      - name: Create ERROR_SUMMARY.txt (always)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import pathlib, re
          log = pathlib.Path("flutter_build.log")
          out = pathlib.Path("ERROR_SUMMARY.txt")

          if not log.exists():
              out.write_text("No flutter_build.log found.\n", encoding="utf-8")
              raise SystemExit(0)

          txt = log.read_text(encoding="utf-8", errors="replace")
          lines = txt.splitlines()

          # pick meaningful error-ish lines; fallback to last 200 lines
          rx = re.compile(r"(Error:|FAILURE:|Exception:|Unhandled exception|Gradle task|Target of URI doesn't exist)", re.I)
          picked = [l for l in lines if rx.search(l)]
          if not picked:
              picked = lines[-200:]

          out.write_text("Extracted error summary:\n\n" + "\n".join(picked[-200:]) + "\n", encoding="utf-8")
          PY

      - name: Package artifacts
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifact
          cp -v flutter_build.log ERROR_SUMMARY.txt artifact/ 2>/dev/null || true
          cp -v build_out/*.apk artifact/ 2>/dev/null || true
          (cd artifact && zip -qr ../android-build.zip .)
          ls -lah android-build.zip

      - name: Upload artifact (android-build.zip)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: android-build.zip

      - name: Fail job if build failed
        if: ${{ steps.build.outputs.exitcode != '0' }}
        run: |
          echo "Flutter build failed. Download artifact and read ERROR_SUMMARY.txt + flutter_build.log"
          exit 1 
