name: Build Android APK (from ZIP)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Extract ZIP + Detect Flutter root
        shell: bash
        run: |
          set -euo pipefail

          ZIP="$(find . -maxdepth 3 -type f -name '*.zip' ! -name 'android-build*.zip' | head -n 1 || true)"
          if [ -z "$ZIP" ]; then
            echo "No project ZIP found in repo."
            exit 1
          fi

          rm -rf extracted
          mkdir -p extracted
          unzip -q "$ZIP" -d extracted

          ROOT="$(python3 - <<'PY'
from pathlib import Path
base = Path("extracted")
cands = sorted(base.rglob("pubspec.yaml"), key=lambda p: len(p.parts))
print(str(cands[0].parent) if cands else "")
PY
)"
          if [ -z "$ROOT" ]; then
            echo "No pubspec.yaml found inside ZIP."
            exit 1
          fi

          echo "ROOT=$ROOT" >> "$GITHUB_ENV"
          echo "Detected ROOT=$ROOT"

      - name: Flutter pub get
        shell: bash
        run: |
          set -euo pipefail
          cd "$ROOT"
          flutter --version
          flutter pub get

      - name: Build APKs (release split per ABI)
        id: build
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          cd "$ROOT"
          flutter build apk --release --split-per-abi

      - name: Collect outputs (always)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          if [ -d "$ROOT/build/app/outputs/flutter-apk" ]; then
            cp -v "$ROOT/build/app/outputs/flutter-apk/"*.apk out/ || true
          fi
          echo "Build outcome: ${{ steps.build.outcome }}" > out/ERROR_SUMMARY.txt

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: out

      - name: Fail job if build failed
        if: ${{ steps.build.outcome != 'success' }}
        run: |
          echo "Flutter build failed. Download artifact 'android-build' and open ERROR_SUMMARY.txt"
          exit 1
